<div class="invoice-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="spinner-border text-center mt-5" role="status">
    <span class="visually-hidden">در حال بارگذاری...</span>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="alert alert-danger m-4">
    {{ error }}
  </div>

  <!-- Invoice Content -->
  <div *ngIf="factor && !loading" id="invoiceContent" class="invoice-content">
    <!-- Header -->
    <div class="invoice-header">
      <div class="store-logo">
        <div class="logo-circle">
          <ng-container *ngIf="!storeLogoUrl"> {{ storeName.substring(0, 1) }}</ng-container>
          <img *ngIf="storeLogoUrl" [lazyLoad]="storeLogoUrl" alt="storeName.substring(0, 1)">
        </div>
      </div>
      <div class="store-info">
        <h1 class="store-name">{{ storeName }}</h1>
        <p class="invoice-title">فاکتور فروش</p>
      </div>
    </div>

    <!-- Invoice Meta Info -->
    <div class="invoice-meta">
      <div class="meta-row">
        <div class="meta-item">
          <span class="meta-label">شماره فاکتور:</span>
          <span class="meta-value">#{{ factor.id | persianNumber }}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">تاریخ:</span>
          <span class="meta-value">{{ factor.sellDateTime | date: 'yyyy/MM/dd' }}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">وضعیت:</span>
          <span class="meta-value">
            <span *ngIf="factor.isClosed" class="badge bg-success">بسته شده</span>
            <span *ngIf="!factor.isClosed" class="badge bg-warning">باز</span>
          </span>
        </div>
      </div>
    </div>

    <!-- Customer Info -->
    <div class="customer-section">
      <div class="section-title">اطلاعات فروشگاه</div>
      <div class="customer-details">
        <div class="detail-row">
          <span class="detail-label">نام:</span>
          <span class="detail-value">{{ storeName }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">توضیحات:</span>
          <span class="detail-value">{{ factor.store?.description || '-' }}</span>
        </div>
      </div>
    </div>

    <!-- Items Table -->
    <table class="items-table">
      <thead>
        <tr>
          <th>#</th>
          <th>محصول</th>
          <th>قیمت واحد</th>
          <th>تعداد</th>
          <th>تخفیف</th>
          <th>جمع</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of factor.factorItems; let i = index">
          <td>{{ i + 1 | persianNumber }}</td>
          <td>{{ item.product?.name }}</td>
          <td>{{ item.price | rial }}</td>
          <td>{{ item.quantity | persianNumber }}</td>
          <td>
            <span *ngIf="item.offPercent > 0">{{ item.offPercent | persianNumber }}%</span>
            <span *ngIf="item.offPercent === 0">-</span>
          </td>
          <td class="item-total">
            {{ ((item.price * item.quantity) - ((item.price * item.quantity) * (item.offPercent / 100))) | rial }}
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Summary -->
    <div class="invoice-summary">
      <div class="summary-row">
        <span class="summary-label">جمع کل:</span>
        <span class="summary-value">{{ getTotal() | rial }}</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">مالیات (۹%):</span>
        <span class="summary-value">{{ getTaxAmount() | rial }}</span>
      </div>
      <div class="summary-row total-row">
        <span class="summary-label">مجموع نهایی:</span>
        <span class="summary-value">{{ getFinalTotal() | rial }}</span>
      </div>

      <div *ngIf="factor.description" class="summary-row notes-row">
        <span class="summary-label">توضیحات:</span>
        <span class="summary-value">{{ factor.description }}</span>
      </div>
    </div>

    <!-- Footer -->
    <div class="invoice-footer">
      <p>متشکرم از خریدتان</p>
      <p class="footer-note">این فاکتور توسط سامانه <strong>فاکتورنو</strong> تهیه شده است</p>
    </div>
  </div>

  <!-- Action Buttons -->
  <div *ngIf="factor && !loading" class="invoice-actions">
    <button class="btn btn-primary" (click)="printInvoice()" id="printBtn">
      <i class="fas fa-print"></i> پرینت
    </button>
    <button class="btn btn-success" (click)="downloadPDF()">
      <i class="fas fa-file-pdf"></i> دانلود PDF
    </button>
  </div>
</div>
